<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agregar Pr√©stamo</title>
  <link rel="stylesheet" href="../styles.css/styles.css">
</head>

<body>
  <div class="contenedor">
    <img src="../img/logo.png" alt="Logo" class="logo" />

    <div class="usuario">
      <div class="foto-perfil" id="fotoPerfil"></div>
      <span id="nombreAdmin">Administrador</span>
    </div>

    <h2>Agregar Pr√©stamo</h2>

    <div class="buscador">
       <input list="listaAlumnos" id="buscarAlumno" placeholder="Buscar alumno...">
       <datalist id="listaAlumnos"></datalist>

    </div>

    <select id="categoria">
     <option value="Acad√©micos">Acad√©micos</option>
     <option value="Art√≠sticos">Art√≠sticos</option>
     <option value="Deportivos">Deportivos</option>
     </select>

     <input list="listaArticulos" id="nombreArticulo" placeholder="Buscar art√≠culo...">
     <datalist id="listaArticulos"></datalist>

    <input type="number" id="cantidad" placeholder="Cantidad">
    <input type="date" id="fecha">
    <input type="text" id="horaInicio" placeholder="Horario de pr√©stamo">
    <input type="text" id="horaFin" placeholder="Horario de devoluci√≥n">

    <button class="btn-agregar" onclick="agregarPrestamo()">Agregar</button>

    <div class="casita">
      <img src="../img/iconocasa.png" alt="Inicio" onclick="irAlInicio()" />
    </div>
  </div>

  <script>
    const fotoPerfil = document.getElementById("fotoPerfil");
    const imagenPerfil = localStorage.getItem("fotoPerfilAdmin");
    if (imagenPerfil) {
      fotoPerfil.style.backgroundImage = `url('${imagenPerfil}')`;
    }

    const nombre = localStorage.getItem("nombreAdmin");
    if (nombre) {
      document.getElementById("nombreAdmin").textContent = nombre;
    }

    function agregarPrestamo() {
      const alumno = document.getElementById("buscarAlumno").value;
      const categoria = document.getElementById("categoria").value;
      const articulo = document.getElementById("nombreArticulo").value;
      const cantidad = document.getElementById("cantidad").value;
      const fecha = document.getElementById("fecha").value;
      const horaInicio = document.getElementById("horaInicio").value;
      const horaFin = document.getElementById("horaFin").value;

      if (alumno && categoria && articulo && cantidad && fecha && horaInicio && horaFin) {
        alert("Pr√©stamo agregado correctamente.");
        document.getElementById("buscarAlumno").value = "";
        document.getElementById("categoria").value = "Academico";
        document.getElementById("nombreArticulo").value = "";
        document.getElementById("cantidad").value = "";
        document.getElementById("fecha").value = "";
        document.getElementById("horaInicio").value = "";
        document.getElementById("horaFin").value = "";
      } else {
        alert("Por favor completa todos los campos.");
      }
    }

    function irAlInicio() {
      window.location.href = "inicio.html";
    }


   async function cargarAlumnos() {
  try {
    const res = await fetch("https://prestamosback-zfcp.onrender.com/api/usuarios");
    const alumnos = await res.json();
    const datalist = document.getElementById("listaAlumnos");

    alumnos
      .filter(a => a.rol === "Estudiante")
      .forEach(alumno => {
        const option = document.createElement("option");
        option.value = alumno.nombre;
        datalist.appendChild(option);
      });
  } catch (err) {
    console.error("Error al cargar alumnos:", err);
  }
}

cargarAlumnos();

async function cargarArticulosLive() {
  const input = document.getElementById("nombreArticulo").value.trim().toLowerCase();
  const categoria = document.getElementById("categoria").value;
  const idAdmin = localStorage.getItem("idAdmin");
  const datalist = document.getElementById("listaArticulos");

  console.log("üü¢ Buscar art√≠culo:", input, "| Categor√≠a:", categoria, "| idAdmin:", idAdmin);

  datalist.innerHTML = "";

  if (input.length < 2 || !categoria || !idAdmin) {
    console.log("üî¥ No se cumplen condiciones m√≠nimas");
    return;
  }

  try {
    const url = `https://prestamosback-zfcp.onrender.com/api/articulos/por-admin/${idAdmin}?categoria=${categoria}`;
    console.log("üì° Haciendo fetch:", url);

    const res = await fetch(url);
    const articulos = await res.json();

    console.log("üì¶ Art√≠culos recibidos:", articulos);

    const filtrados = articulos.filter(art =>
      art.nombre.toLowerCase().startsWith(input)
    );

    console.log("‚úÖ Coincidencias:", filtrados);

    filtrados.forEach(art => {
      const option = document.createElement("option");
      option.value = art.nombre;
      datalist.appendChild(option);
    });
  } catch (err) {
    console.error("‚ùå Error al buscar art√≠culos:", err);
  }
}


document.getElementById("categoria").addEventListener("change", () => {
  document.getElementById("nombreArticulo").value = "";
  document.getElementById("listaArticulos").innerHTML = "";
});

document.getElementById("nombreArticulo").addEventListener("input", cargarArticulosLive);


  </script>
</body>

</html>
